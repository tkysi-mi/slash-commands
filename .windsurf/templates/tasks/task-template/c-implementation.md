# 実装タスクリスト

<!--
このドキュメントについて:
  - 格納場所: docs/tasks/task000001-{スラッグ}/c-implementation.md
  - 作成方法: /b-003-CreateTaskImplementation ワークフローで作成
  - 実行方法: /c-001-ImplementTask ワークフローで各ステップを実行
  - 前提条件: a-definition.md と b-research.md が作成済みであること
  - 関連ドキュメント:
    - a-definition.md (タスク定義ドキュメント)
    - b-research.md (リサーチドキュメント)

このドキュメントの目的:
  - 実装作業を段階的に分割して管理
  - 進捗の可視化とチーム共有
  - 各ステップの成果物を明確化
  - 実装漏れの防止

更新タイミング:
  - 実装開始前にフェーズ分割を計画
  - 各ステップ完了時にチェック（/c-001-ImplementTask が自動更新）
  - 新たな作業が発覚した際に追加
  - レビュー指摘事項を反映
-->

---

## フェーズ 1: [フェーズ名]

<!--
フェーズの分け方:
  - 機能単位で分割（例: フロントエンド → バックエンド → 統合）
  - 依存関係で分割（例: データモデル → API → UI）
  - リスクで分割（例: 検証 → 本実装 → 最適化）

ベストプラクティス:
  - 1フェーズは 1-3 日以内で完了できる粒度
  - フェーズごとに動作確認可能な状態にする
  - 各フェーズで小さくコミット・PR を作成（レビュー負荷軽減）
-->

**目的:** <!-- 例: データモデルと API エンドポイントの実装 -->

**完了条件:** <!-- 例: API が期待通りのレスポンスを返し、ユニットテストが全て通る -->

### ステップ

<!--
ステップの粒度:
  - 1ステップは 1-3 時間程度で完了できる作業
  - コミット単位で分割すると管理しやすい
  - 成果物が明確であること（ファイル、機能、テスト）

記載のポイント:
  - 具体的なファイル名やコンポーネント名を含める
  - 実装の詳細にはアルゴリズムや技術的な注意点を記載
  - 依存関係があるステップは順序を意識
-->

- [ ] **ステップ 1:** データベーススキーマの定義
  - **成果物:** `migrations/001_create_users_table.sql`
  - **詳細:** User テーブルに `email_verified`, `verification_token`, `token_expires_at` を追加。インデックスは `verification_token` に作成

- [ ] **ステップ 2:** TypeScript 型定義の追加
  - **成果物:** `src/types/User.ts`
  - **詳細:** `User` インターフェースに新しいフィールドを追加。Zod スキーマも同時に定義

- [ ] **ステップ 3:** メール送信 API エンドポイントの実装
  - **成果物:** `src/api/auth/send-verification.ts`
  - **詳細:** トークン生成（UUID v4）、有効期限 24 時間、SendGrid API 呼び出し。エラーハンドリング実装

- [ ] **ステップ 4:** メール認証 API エンドポイントの実装
  - **成果物:** `src/api/auth/verify-email.ts`
  - **詳細:** トークン検証、有効期限チェック、ユーザーステータス更新。無効トークンは 400 エラー

---

## フェーズ 2: [フェーズ名]

**目的:** <!-- 例: フロントエンド UI の実装とユーザーフロー統合 -->

**完了条件:** <!-- 例: ユーザー登録から認証完了までの一連の流れが動作し、E2E テストが通る -->

### ステップ

- [ ] **ステップ 1:** メール認証ページの作成
  - **成果物:** `src/pages/EmailVerificationPage.tsx`
  - **詳細:** URL パラメータからトークンを取得、API 呼び出し、成功/失敗メッセージ表示

- [ ] **ステップ 2:** ユーザー登録フォームにメール送信処理を追加
  - **成果物:** `src/features/auth/RegisterForm.tsx` を更新
  - **詳細:** 登録成功後にメール送信 API を呼び出し、「確認メールを送信しました」メッセージを表示

- [ ] **ステップ 3:** 認証状態のガード実装
  - **成果物:** `src/middleware/requireEmailVerified.ts`
  - **詳細:** 未認証ユーザーは特定ページにアクセス不可。リダイレクト処理を実装

---

## フェーズ 3: テスト・ドキュメント

<!--
テストフェーズの重要性:
  - 実装と同時にテストを書くことでバグを早期発見
  - テストコードは仕様書の役割も果たす
  - リグレッション防止（今後の変更で既存機能が壊れない）

記載すべきテスト:
  - ユニットテスト（関数、コンポーネント単位）
  - 統合テスト（API、データベース連携）
  - E2E テスト（ユーザーフロー全体）
  - エッジケーステスト（異常系、境界値）
-->

**目的:** <!-- 例: テストコード作成とドキュメント整備 -->

**完了条件:** <!-- 例: テストカバレッジ 80% 以上、README にセットアップ手順を記載 -->

### ステップ

- [ ] **ステップ 1:** ユニットテストの作成
  - **成果物:** `src/api/auth/send-verification.test.ts`, `verify-email.test.ts`
  - **詳細:** トークン生成、有効期限検証、エラーハンドリングのテスト。モックを使用

- [ ] **ステップ 2:** 統合テストの作成
  - **成果物:** `tests/integration/email-verification.test.ts`
  - **詳細:** API エンドポイントの実際の動作をテスト。テストデータベース使用

- [ ] **ステップ 3:** E2E テストの作成
  - **成果物:** `tests/e2e/user-registration.spec.ts`
  - **詳細:** Playwright でユーザー登録→メール確認→ログインまでの流れをテスト

- [ ] **ステップ 4:** ドキュメント更新
  - **成果物:** `README.md`, `docs/tasks/task000001-{スラッグ}/a-definition.md`
  - **詳細:** セットアップ手順、環境変数設定、API 仕様を記載

---

## 受け入れ基準

<!--
受け入れ基準の記載ポイント:
  - 機能が正しく動作すること（正常系）
  - エラーハンドリングが適切に実装されていること（異常系）
  - エッジケースが処理されること（境界値、特殊な入力）
  - パフォーマンス要件を満たすこと（必要に応じて）
  - セキュリティ要件を満たすこと（XSS, CSRF, SQL Injection など）
  - ブラウザ互換性（必要に応じて）
  - テストが全て通ること
  - ドキュメントが更新されていること

各フェーズの完了を判断するための具体的な基準を記載します。
全ての基準を満たした時点でタスク完了とみなされます。
-->

### フェーズ 1 の受け入れ基準
- [ ] データベースマイグレーションが成功する
- [ ] 型定義が正しく適用される（TypeScript コンパイルエラーなし）
- [ ] メール送信 API がトークンを生成し、メールを送信する
- [ ] 無効なトークンでアクセスした場合、エラーが返る
- [ ] トークンの有効期限切れが正しく検出される

### フェーズ 2 の受け入れ基準
- [ ] メール認証ページが正しく表示される
- [ ] 認証成功時に成功メッセージが表示される
- [ ] 認証失敗時にエラーメッセージが表示される
- [ ] 未認証ユーザーは保護されたページにアクセスできない
- [ ] 認証済みユーザーは全ての機能にアクセスできる

### フェーズ 3 の受け入れ基準
- [ ] 全てのユニットテストが通る
- [ ] 全ての統合テストが通る
- [ ] E2E テストが通る（CI 環境でも実行）
- [ ] テストカバレッジが 80% 以上
- [ ] ドキュメントに記載された手順で環境構築できる

---

## メモ

<!--
実装全体に関する補足情報

記載すべき内容:
  - 実装中に気づいた技術的な課題
  - リファクタリングが必要な箇所
  - パフォーマンス最適化の余地
  - セキュリティ上の注意点
  - 今後の拡張予定
  - チームメンバーへの引き継ぎ事項

例:
- メール送信は現在同期処理だが、将来的にはジョブキューに移行予定
- トークンの有効期限は現在 24 時間だが、設定ファイルで変更可能にする
- SendGrid の API キーは環境変数で管理（.env.example に記載）
- セキュリティレビュー完了（2025-01-15、レビュアー: @john）
-->
