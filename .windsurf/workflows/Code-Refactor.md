---
description: 技術的負債の棚卸しから改善案立案・リファクタリング実施・検証までを体系化したコード改善ワークフロー
auto_execution_mode: 1
---

# /refactoring-expert

## 目的

- 技術的負債やコードスメルを体系的に洗い出し、優先度に基づく改善を実施する。
- SOLID原則やデザインパターンを適用し、保守性・可読性・テスト容易性を高める。
- リファクタリング結果を裏付けるテストとメトリクスを整備し、継続的改善サイクルを確立する。

## 前提

- 対象リポジトリの最新ブランチを取得済みで、既存テストが動作すること。
- 静的解析ツール（Ruff / ESLint / Stylelint など）とテストランナー（pytest / npm test 等）が `run_command` または既存ランナブル経由で実行可能。
- 依存する設計ガイドラインやコーディング規約、アーキテクチャ決定記録（ADR）が参照可能。
- 影響範囲が大きい場合は、レビュー担当者や関係チーム（QA / SRE / プロダクトオーナー）と連携できる体制が整っていること。

## 手順

1. **スコーピングとゴール定義**
   - 依頼元の課題（例: 高循環複雑度、重複ロジック、依存性の肥大化）をヒアリングし、改善完了の判定基準を明文化する。
   - 影響範囲（モジュール、サービス、UIコンポーネントなど）とリスクレベルを整理し、必要ならステークホルダーの承認を得る。

2. **現状診断と負債インベントリ作成**
   - 静的解析（`run_command` で Ruff / ESLint / sonar など）を実行し、重大度別に指摘を収集する。
   - 循環的複雑度・LOC・依存グラフなどのメトリクスを取得し、改善効果の測定項目を決定する。
   - コードレビューやログ調査を通じて、ドメイン知識を持つメンバーから非機能的な問題（パフォーマンス、セキュリティ）もヒアリングする。

3. **改善方針と設計プランの策定**
   - SOLID 原則／デザインパターン適用方針、分割単位（モジュール化、関数抽出、クラス化）を決定する。
   - 変更前後の依存関係図や簡易シーケンスを作成し、副作用の有無を評価する。

4. **安全策とテスト体制の準備**
   - 既存テストのカバレッジを確認し、欠けているユースケースは先にテスト追加またはゴールデンマスター生成でカバーする。
   - 回帰防止のための統合テスト／スナップショットテスト／E2E（Playwright MCP や既存CI）を実行計画に組み込む。
   - リファクタリング前にブランチを切り、CI/CDパイプラインや検証用環境が正しく動くか確認する。

5. **リファクタリング実施**
   - 小さなコミット単位で変更し、各ステップ後に lint・フォーマッタ・単体テストを実行して動作確認する。
   - 変換処理が大規模な場合は MorphLLM などのコード変換MCPを活用しつつ、生成結果をレビュー基準に照らして手修正する。
   - 公開APIやドメイン契約を変更する場合は、互換性やマイグレーション手順を同時に整備する。

6. **検証と品質ゲート通過**
   - 追加・更新したテストが成功することを確認し、CIステータスとカバレッジ変化を記録する。
   - スタティックアナライザの再実行で警告が減少しているか、残課題がある場合は理由と対応計画を明記する。
   - Web UI 変更を伴う場合は Playwright MCP や Chrome DevTools MCP でレンダリング／パフォーマンスを検証する。

7. **レビュー準備とナレッジ共有**
   - 変更の意図、リファクタリングパターン、残課題を PR テンプレートやドキュメントに整理する。
   - 影響範囲を受けるドキュメント（設計図、開発ガイド、スタイルガイド）を更新し、PM Agent へのナレッジ登録を検討する。
   - レビュワーに必要な検証手順やスクリーンショット／ログを添付し、レビューサイクルを円滑化する。

8. **フォローアップ**
   - デプロイ後のモニタリング（エラーレート、レスポンス時間、ユーザー行動）をチェックし、回帰がないか確認する。
   - 追加で必要な改善項目や後続タスクが判明した場合は、技術負債リストやバックログへ記録する。
   - リファクタリングの効果（メトリクス改善、レビュー所要時間短縮など）を定量的に振り返り、学びを共有する。

## 完了条件

- リファクタリング対象の課題が解消され、事前に定めた成功基準を満たしている。
- lint・テスト・カバレッジ・パフォーマンスなどの品質ゲートが通過し、残課題は文書化されている。
- 変更内容・検証結果・フォローアップが関係者へ共有され、レビューまたはデプロイ準備が整っている。

## エスカレーション

- 重大な設計変更やビジネス影響が懸念される場合は、アーキテクト／プロダクトオーナーと合意形成する。
- リファクタリング過程でブロッキングなバグや既存仕様の不備に遭遇した際は、直ちにチームリードへ報告し対応方針を協議する。
- CI/CD や MCP ツールで障害が発生し作業継続が困難な場合は、SRE/DevOps担当へ連絡し復旧を依頼する。